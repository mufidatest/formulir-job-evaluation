<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Pembuatan Job</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select, textarea {
            width: 300px;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            display: none; /* Sembunyikan secara default */
        }
        #loadingMessage {
            background-color: #e0f7fa;
            color: blue;
            display: none;
        }
        #successMessage {
            background-color: #d4edda;
            color: green;
        }
        #errorMessage {
            background-color: #f8d7da;
            color: red;
        }
    </style>
</head>
<body>
    <h1>Formulir Pembuatan Job</h1>
    <p>Pilih job dari daftar yang ada atau masukkan job baru.</p>

    <div id="loadingMessage" class="message">Memuat daftar job...</div>
    <div id="errorMessage" class="message">Gagal memuat daftar job. Silakan coba lagi nanti atau masukkan secara manual.</div>

    <form id="jobForm">
        <label for="jobListDropdown">Pilih Job (jika ada di daftar):</label>
        <select id="jobListDropdown" name="selectedJob">
            <option value="">-- Pilih --</option>
        </select>

        <label for="newJobName" style="margin-top: 15px;">Atau Masukkan Nama Job Baru (jika tidak ada di daftar):</label>
        <input type="text" id="newJobName" name="newJob" placeholder="Nama job baru">
        <label for="documentationLink" style="margin-top: 15px;">Documentation Link:</label>
        <input type="text" id="documentationLink" name="documentationLink" placeholder="Wajib diisi jika job baru">

        <label for="notes" style="margin-top: 15px;">Catatan Tambahan (Opsional):</label>
        <textarea id="notes" name="notes" rows="4" placeholder="Tulis catatan di sini..."></textarea>

        <button type="submit">Kirim Data</button>
    </form>

    <div id="successMessage" class="message">Data berhasil dikirim!</div>

   <script>
    // URL Webhook Anda
    const N8N_JOB_DROPDOWN_WEBHOOK_URL = 'https://qoalapopstesting.app.n8n.cloud/webhook/0ea8a830-363c-40cf-bbce-269e1ecb7ab5';
    const N8N_SUBMIT_WEBHOOK_URL = 'https://qoalapopstesting.app.n8n.cloud/webhook/27983d7f-fa7c-4c53-a367-5f84071e66f6';

    const jobListDropdown = document.getElementById('jobListDropdown');
    const newJobNameInput = document.getElementById('newJobName');
    const jobForm = document.getElementById('jobForm');
    const loadingMessage = document.getElementById('loadingMessage');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const documentationLinkInput = document.getElementById('documentationLink');
    let jobListWithLinks = [];

    // Fungsi untuk mengambil data dropdown Job dari n8n
    async function fetchJobData() {
        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        console.log("Mulai mengambil data job...");
        try {
            const response = await fetch(N8N_JOB_DROPDOWN_WEBHOOK_URL);
            console.log("Respon diterima:", response);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            jobListWithLinks = await response.json();
            console.log("Data JSON diterima:", jobListWithLinks);
            
            jobListDropdown.innerHTML = '<option value="">-- Pilih --</option>'; 

            jobListWithLinks.forEach(job => {
                console.log("Menambahkan job:", job.label);
                const option = document.createElement('option');
                option.value = job.value;
                option.textContent = job.label;
                jobListDropdown.appendChild(option);
            });
            loadingMessage.style.display = 'none';
            console.log("Selesai mengisi dropdown.");
        } catch (error) {
            console.error("Error fetching job list:", error);
            loadingMessage.style.display = 'none';
            errorMessage.textContent = 'Gagal memuat daftar job. Silakan coba lagi nanti atau masukkan secara manual.';
            errorMessage.style.display = 'block';
        }
    }

    // Panggil fungsi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', fetchJobData);

    // Logika untuk menonaktifkan/mengaktifkan input job
    jobListDropdown.addEventListener('change', function() {
        const selectedJobValue = this.value;
        if (selectedJobValue) {
            newJobNameInput.value = '';
            newJobNameInput.disabled = true;
            // CARI LINK CONFLUENCE YANG SESUAI DARI DATA YANG DIUNDUH
            const selectedJobData = jobListWithLinks.find(job => job.value === selectedJobValue);
            if (selectedJobData && selectedJobData.documentationLink) {
                documentationLinkInput.value = selectedJobData.documentationLink;
                documentationLinkInput.disabled = true; // Nonaktifkan jika sudah ada link
            }
        } else {
            newJobNameInput.disabled = false;
            documentationLinkInput.value = ''; // Kosongkan
            documentationLinkInput.disabled = false; // Aktifkan
        }
    });

    newJobNameInput.addEventListener('input', function() {
        if (this.value) { // Jika ada teks di input job baru
            jobListDropdown.value = ''; // Kosongkan pilihan dropdown
            jobListDropdown.disabled = true; // Nonaktifkan dropdown
            documentationLinkInput.disabled = false; // Aktifkan input link
        } else {
            jobListDropdown.disabled = false; // Aktifkan dropdown
            documentationLinkInput.disabled = false; // Aktifkan input link
        }
    });

    // Fungsi untuk mengirim data formulir ke n8n
    jobForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // Mencegah form dari reload halaman
        
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';

        const selectedJob = jobListDropdown.value;
        const newJob = newJobNameInput.value;
        const notes = document.getElementById('notes').value;
        const documentationLinkValue = documentationLinkInput.value;

        let finalJobName = '';
        let inputType = '';

        if (selectedJob) {
            finalJobName = selectedJob;
            inputType = 'Dropdown Selection';
        } else if (newJob) {
            if (!documentationLinkValue) {
                errorMessage.textContent = 'Harap sertakan Documentation Link jika Anda memasukkan job baru.';
                errorMessage.style.display = 'block';
                return; // Berhenti jika tidak ada link
            }
            finalJobName = newJob;
            inputType = 'Free Text';
        } else {
            errorMessage.textContent = 'Silakan pilih job dari daftar atau masukkan nama job baru.';
            errorMessage.style.display = 'block';
            return; // Berhenti jika tidak ada
        }

        try {
            const formData = {
                jobName: finalJobName,
                inputType: inputType,
                notes: notes,
                documentationLink: documentationLinkValue // <-- UBAH KUNCI DI SINI
            };
            console.log("Data yang akan dikirim:", formData);

            const response = await fetch(N8N_SUBMIT_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log("Respon dari n8n (POST):", result);

            successMessage.style.display = 'block';
            jobForm.reset();
            jobListDropdown.disabled = false;
            newJobNameInput.disabled = false;
            documentationLinkInput.disabled = false;

        } catch (error) {
            console.error("Error submitting form:", error);
            errorMessage.textContent = 'Terjadi kesalahan saat mengirim data. Silakan coba lagi.';
            errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>